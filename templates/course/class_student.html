{% extends "course/nav.html" %}
{% block title %}选课系统-课程学生管理{% endblock %}
{% block nav-title %}欢迎使用选课系统{% endblock %}

{% block content %}
<div class="main-container mdui-container">
    <div id="search-course">
        <div class="mdui-row">
            <div class="main-header mdui-typo">
                <div class="mdui-col-xs-12">
                    <h1>课程学生管理</h1>
                    <h2 id="class-name"></h2>
                </div>
            </div>
        </div>
    </div>

    <div class="mdui-btn mdui-color-theme-accent" onclick="addStudent();">添加学生</div>

    <div>
        <table class="mdui-table mdui-table-hoverable">
            <thead>
                <tr>
                    <td>学号</td>
                    <td>姓名</td>
                    <td>成绩</td>
                    <td>操作</td>
                </tr>
            </thead>
            <tbody id="table-body">

            </tbody>
        </table>
    </div>

    </br>

    <div class="mdui-typo">
        <p class="mdui-row-md-9" id="page-selector">

        </p>
        <p id="page-count">

        </p>
    </div>

    <div class="mdui-dialog" id="input-dialog">
        <div class="mdui-dialog-title" id="input-dialog-title"></div>
        <div class="mdui-dialog-content mdui-textfield">
            <input class="mdui-textfield-input" type="text" id='input-dialog-input' />
        </div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-ripple" mdui-dialog-cancel>取消</button>
            <button class="mdui-btn mdui-ripple" mdui-dialog-confirm>确认</button>
        </div>
    </div>

    <div id='current-page' hidden>1</div>

</div>
{% endblock %}

{% block script %}
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.1.min.js"></script>

<script>
    $(document).ready(function () {
        getStudents();
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getStudents() {
        var f = new FormData();
        f.append("class_id", {{ class_id }});
        $.ajax({
            url: "{% url 'get_class_student_api' %}",
            type: 'POST',
            cache: false,
            data: f,
            dataType: "json",
            processData: false,
            contentType: false,
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            success: function (res) {
                $("#progress-bar").prop("hidden", "hidden");
                $("#class-name").html((res.data.class_name))
                drawTable(res.data.student);
                drawPList(res.data.plist, res.data.page);
            },
            error: function (res) {
                $("#progress-bar").prop("hidden", "hidden");
                mdui.snackbar({ message: "获取学生列表失败", position: 'top' });
            }
        });
    }

    function addStudent() {
        $("#input-dialog-title").html("添加学生");
        $('#input-dialog-input').val("");
        $('#input-dialog-input').prop("placeholder", "学生uid");
        var diag = new mdui.Dialog('#input-dialog');
        diag.open();
        delete diag;
        $('#input-dialog').one('confirm.mdui.dialog', function () {
            var sid = $('#input-dialog-input').val();
            var f = new FormData();
            f.append("class_id", {{ class_id }});
            f.append("student_id", sid);
            f.append("operation", "assign");
            $.ajax({
                url: "{% url 'assign_student_to_class_api' %}",
                type: 'POST',
                cache: false,
                data: f,
                dataType: "json",
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                success: function (res) {
                    $("#progress-bar").prop("hidden", "hidden");
                    mdui.snackbar({ message: res.message, position: 'top' });
                    getStudents();
                },
                error: function (res) {
                    $("#progress-bar").prop("hidden", "hidden");
                    mdui.snackbar({ message: "操作失败", position: 'top' });
                }
            });
        });
        $('#input-dialog').one('close.mdui.dialog', function () {
            $("#input-dialog").unbind("confirm.mdui.dialog");
        });
    }

    function scoreStudent(uid) {
        $("#input-dialog-title").html("为" + uid + "打分");
        $('#input-dialog-input').val("");
        $('#input-dialog-input').prop("placeholder", "分数");
        var diag = new mdui.Dialog('#input-dialog');
        diag.open();
        delete diag;
        $('#input-dialog').one('confirm.mdui.dialog', function () {
            var score = $('#input-dialog-input').val();
            var f = new FormData();
            f.append("class_id", {{ class_id }});
            f.append("student_id", uid);
            f.append("score", score)
            $.ajax({
                url: "{% url 'score_student_api' %}",
                type: 'POST',
                cache: false,
                data: f,
                dataType: "json",
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                success: function (res) {
                    $("#progress-bar").prop("hidden", "hidden");
                    mdui.snackbar({ message: res.message, position: 'top' });
                    getStudents();
                },
                error: function (res) {
                    $("#progress-bar").prop("hidden", "hidden");
                    mdui.snackbar({ message: "操作失败", position: 'top' });
                }
            });
        });
        $('#input-dialog').one('close.mdui.dialog', function () {
            $("#input-dialog").unbind("confirm.mdui.dialog");
        });
    }

    function removeStudent(uid) {
        $("#input-dialog-title").html("确定要移除学生" + uid + "吗？");
        $('#input-dialog-input').val("");
        $('#input-dialog-input').prop("hidden", true);
        var diag = new mdui.Dialog('#input-dialog');
        diag.open();
        delete diag;
        $('#input-dialog').one('confirm.mdui.dialog', function () {
            var sid = $('#input-dialog-input').val();
            var f = new FormData();
            f.append("class_id", {{ class_id }});
            f.append("student_id", uid);
            f.append("operation", "remove");
            $.ajax({
                url: "{% url 'assign_student_to_class_api' %}",
                type: 'POST',
                cache: false,
                data: f,
                dataType: "json",
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                success: function (res) {
                    $("#progress-bar").prop("hidden", "hidden");
                    mdui.snackbar({ message: res.message, position: 'top' });
                    getStudents();
                },
                error: function (res) {
                    $("#progress-bar").prop("hidden", "hidden");
                    mdui.snackbar({ message: "操作失败", position: 'top' });
                }
            });
        });
        $('#input-dialog').one('close.mdui.dialog', function () {
            $('#input-dialog-input').prop("hidden", false);
            $("#input-dialog").unbind("confirm.mdui.dialog");
        });
    }

    function drawTable(list) {
        $("#table-body").empty();
        $("table").attr("class", "mdui-table mdui-table-hoverable mdui-table-selectable");
        for (var i = 0; i < list.length; i++) {
            var s = "<tr>";
            var uid;
            for (var j = 0; j < list[i].length; j++) {
                if (j == 0) {
                    uid = list[i][j];
                }
                s = s + "<td>" + list[i][j] + "</td>";
            }
            s = s + "<td>";
            s = s + "<button class='mdui-btn mdui-color-theme-accent' mdui-menu=\"{target: '#menu" + uid + "'}\">操作</button>";
            s = s + "<ul class='mdui-menu' id='menu" + uid + "'>";
            s = s + "<li class='mdui-menu-item'><a onclick='scoreStudent(\"" + uid + "\");' class='mdui-ripple'>打分</a></li>";
            s = s + "<li class='mdui-menu-item'><a onclick='removeStudent(\"" + uid + "\");' class='mdui-ripple'>删除</a></li>";
            s = s + "</ul></td>";
            s = s + "</tr>";
            $("#table-body").append(s);
        }
        mdui.mutation();
    }

    function drawPList(list, current) {
        $("#current-page").html(current);
        $("#page-count").html("第" + current + "页，共" + list[list.length - 1] + "页");
        $("#page-selector").empty();
        for (var i = 0; i < list.length; i++) {
            var s = "<div class='mdui-btn ";
            if (current == list[i]) {
                s = s + "mdui-color-theme-accent ";
            }

            if (list[i] != '...') {
                s = s + "' onclick='searchCourse(false, page=" + list[i] + ");"
            }
            s = s + "'>" + list[i] + "</div>";
            $("#page-selector").append(s);
        }
        mdui.mutation();
    }
</script>
{% endblock %}